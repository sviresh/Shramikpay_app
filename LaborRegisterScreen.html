<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShramikPay</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { padding-top: 70px; }
    .top-bar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .form-container { max-width: 900px; margin: auto; padding: 20px; }
    .btn-save { display: block; margin: 20px auto; width: 200px; }
    #message { text-align: center; margin-top: 10px; font-weight: bold; }
</style>
</head>
<body>

<!-- Top Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary top-bar">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">👷 ShramikPay</a>
        <div class="ms-auto d-flex align-items-center">
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/labor_register'">👷 Labor Register</button>
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/attendance'">🗓️ Attendance</button>
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/payment'">💵 Payment</button>
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/site_material'">🚚 Site Materials</button>
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/site_expenses'">💰 Site Expenses</button>
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/reports'">📊 Reports</button>
            <button class="btn btn-outline-light me-2" onclick="window.location.href='/setup_site'">🏗️ Site Management</button>
            <button class="btn btn-outline-light" onclick="logout()">🚪 Logout</button>
        </div>
    </div>
</nav>

<!-- Labor Registration Form -->
<div class="form-container">
    <form id="laborForm">
        <div class="row g-3">
            <div class="col-md-6"><input type="text" class="form-control" id="name_input" placeholder="Name" required></div>
            <div class="col-md-6"><input type="text" class="form-control" id="address_input" placeholder="Address" required></div>
            <div class="col-md-6"><input type="tel" class="form-control" id="phone_input" placeholder="Phone" required></div>
            <div class="col-md-6"><input type="number" class="form-control" id="age_input" placeholder="Age" required></div>
            <div class="col-md-6"><input type="text" class="form-control" id="upi_input" placeholder="UPI ID"></div>
            <div class="col-md-6"><input type="text" class="form-control" id="bank_input" placeholder="Bank Details"></div>
            <div class="col-md-6"><input type="text" class="form-control" id="aadhaar_input" placeholder="Aadhaar No."></div>
            <div class="col-md-6"><input type="tel" class="form-control" id="emergency_input" placeholder="Emergency Contact"></div>
            <div class="col-md-6"><input type="number" class="form-control" id="wages_input" placeholder="Daily Wages (₹)" step="0.01"></div>
            <div class="col-md-6">
                <select class="form-control" id="site_input" required>
                    <option value="">Select Site</option>
                </select>
            </div>
            <div class="col-md-6"><input type="text" class="form-control" id="role_input" placeholder="Role / Designation" required></div>
        </div>
        <button type="button" class="btn btn-success btn-save" onclick="saveLabor()">💾 Save Labor</button>
        <div id="message"></div>
    </form>
</div>

<!-- JS Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Logout function
function logout() {
    localStorage.removeItem("user");
    window.location.href = "/login";
}

// Load sites from local Flask endpoint
async function loadSites() {
    try {
        const response = await fetch("/get_sites");
        const sites = await response.json();
        const siteSelect = document.getElementById("site_input");
        siteSelect.innerHTML = '<option value="">Select Site</option>';
        sites.forEach(site => {
            siteSelect.innerHTML += `<option value="${site.id}">${site.name}</option>`;
        });
    } catch (err) {
        console.error("Error loading sites:", err);
    }
}

// Save labor via Flask POST
async function saveLabor() {
    const msg = document.getElementById("message");

    const labor = {
        name: document.getElementById("name_input").value.trim(),
        address: document.getElementById("address_input").value.trim(),
        phone: document.getElementById("phone_input").value.trim(),
        age: parseInt(document.getElementById("age_input").value) || null,
        upi: document.getElementById("upi_input").value.trim() || null,
        bank: document.getElementById("bank_input").value.trim() || null,
        aadhaar: document.getElementById("aadhaar_input").value.trim() || null,
        emergency: document.getElementById("emergency_input").value.trim() || null,
        wages: parseFloat(document.getElementById("wages_input").value) || 0,
        site_id: parseInt(document.getElementById("site_input").value) || null,
        role: document.getElementById("role_input").value.trim()
    };

    // Validation
    if (!labor.name || !labor.address || !labor.phone || !labor.age || !labor.site_id || !labor.role) {
        msg.style.color = "red";
        msg.innerText = "⚠️ Please fill in all required fields!";
        return;
    }

    try {
        const response = await fetch("/save_labor", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(labor)
        });
        const result = await response.json();

        if (result.success) {
            msg.style.color = "green";
            msg.innerText = "✅ Labor saved successfully!";
            document.getElementById("laborForm").reset();
        } else {
            msg.style.color = "red";
            msg.innerText = "❌ " + result.message;
        }
    } catch (err) {
        console.error(err);
        msg.style.color = "red";
        msg.innerText = "❌ Unexpected error occurred!";
    }
}

// Initialize page
window.addEventListener("DOMContentLoaded", loadSites);
</script>

</body>
</html>
